trigger:
- main

pool:
  vmImage: ubuntu-latest

stages:
- stage: BuildonPR
  displayName: 'Build on PR'
  condition: eq(variables['Build.Reason'], 'PullRequest')
  jobs:
  - job: TerraformInitAndPlan
    displayName: 'Terraform Init and Plan'
    steps:
    - task: TerraformCLI@0
      inputs:
        command: 'workspace'
        allowTelemetryCollection: true
        workspaceName: 'dev'
    - task: TerraformCLI@0
      inputs:
        command: 'init'
        backendType: 'azurerm'
        backendServiceArm: 'Azure subscription 1(1)(f4210fd4-9a8e-484e-b3ab-bf706abb3785)'
        backendAzureRmSubscriptionId: 'f4210fd4-9a8e-484e-b3ab-bf706abb3785'
        backendAzureRmResourceGroupName: 'tfstate'
        backendAzureRmStorageAccountName: 'dentfstate'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'terraform.tfstate'
        allowTelemetryCollection: true
    - task: TerraformCLI@0
      inputs:
        command: 'validate'
        allowTelemetryCollection: true
    - task: TerraformCLI@0
      inputs:
        command: 'plan'
        allowTelemetryCollection: true
        publishPlanResults: 'tfplan'

- stage: BuildAndDeployDEV
  displayName: 'Build and Deploy DEV'
  jobs:
  - job: TerraformInitAndValidate
    displayName: 'Terraform Install, Init, and Validate'
    steps:
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'
    - task: TerraformCLI@0
      inputs:
        command: 'init'
        backendType: 'azurerm'
        backendServiceArm: 'Azure subscription 1(1)(f4210fd4-9a8e-484e-b3ab-bf706abb3785)'
        backendAzureRmSubscriptionId: 'f4210fd4-9a8e-484e-b3ab-bf706abb3785'
        backendAzureRmResourceGroupName: 'tfstate'
        backendAzureRmStorageAccountName: 'dentfstate'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'terraform.tfstate'
        allowTelemetryCollection: true
    - task: TerraformCLI@0
      inputs:
        command: 'workspace'
        allowTelemetryCollection: true
        workspaceName: 'dev'
    - task: TerraformCLI@0
      inputs:
        command: 'validate'
        allowTelemetryCollection: true
    - task: TerraformCLI@0
      inputs:
        command: 'apply'
        environmentServiceName: 'Azure subscription 1(1)(f4210fd4-9a8e-484e-b3ab-bf706abb3785)'
        providerAzureRmSubscriptionId: 'f4210fd4-9a8e-484e-b3ab-bf706abb3785'
        secureVarsFile: 'terraform.tfvars'
        commandOptions: '--auto-approve'
        allowTelemetryCollection: true

- stage: BuildAndDeployPROD 
  condition: eq(variables['Build.Reason'], 'Manual')
  displayName: 'Build and Deploy PROD'
  jobs:
  - job: waitForValidation
    displayName: Wait for external validation
    pool: server
    timeoutInMinutes: 4320
    steps:
    - task: ManualValidation@0
      timeoutInMinutes: 1440 
      inputs:
        notifyUsers: |
          qwerty165343@gmail.com
        instructions: 'Please validate the build configuration and resume'
        onTimeout: 'resume'
  - job: TerraformInitAndValidate
    displayName: 'Terraform Install, Init, and Validate'
    steps:
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'
    - task: TerraformCLI@0
      inputs:
        command: 'init'
        backendType: 'azurerm'
        backendServiceArm: 'Azure subscription 1(1)(f4210fd4-9a8e-484e-b3ab-bf706abb3785)'
        backendAzureRmSubscriptionId: 'f4210fd4-9a8e-484e-b3ab-bf706abb3785'
        backendAzureRmResourceGroupName: 'tfstate'
        backendAzureRmStorageAccountName: 'dentfstate'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'terraform.tfstate'
        allowTelemetryCollection: true
    - task: TerraformCLI@0
      inputs:
        command: 'workspace'
        allowTelemetryCollection: true
        workspaceName: 'prod'
    - task: TerraformCLI@0
      inputs:
        command: 'validate'
        allowTelemetryCollection: true
    - task: TerraformCLI@0
      inputs:
        command: 'apply'
        environmentServiceName: 'Azure subscription 1(1)(f4210fd4-9a8e-484e-b3ab-bf706abb3785)'
        providerAzureRmSubscriptionId: 'f4210fd4-9a8e-484e-b3ab-bf706abb3785'
        secureVarsFile: 'terraform.tfvars'
        commandOptions: '--auto-approve'
        allowTelemetryCollection: true